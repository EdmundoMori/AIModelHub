<div class="benchmarking-page">
  <section class="hero">
    <div class="hero-top">
      <div class="hero-title">
        <p class="eyebrow">Benchmarking Studio</p>
        <h1>Model Benchmarking</h1>
        <p class="subtitle">
          Execute multiple HTTP models in parallel, compare performance metrics,
          and identify the best candidate for deployment.
        </p>
      </div>
      <div class="hero-actions">
        <button class="btn primary" (click)="runRanking()" [disabled]="!canRunBenchmark || isRunning">
          <mat-icon *ngIf="!isRunning">play_circle</mat-icon>
          <mat-icon *ngIf="isRunning">
            <mat-spinner diameter="20"></mat-spinner>
          </mat-icon>
          {{ isRunning ? 'Running...' : 'Run Benchmark' }}
        </button>
      </div>
    </div>

    <div class="hero-stats">
      <div class="stat-card">
        <div class="stat-label">Models selected</div>
        <div class="stat-value">{{ selectedCount }}</div>
        <div class="stat-foot">HTTP models ready</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Task type</div>
        <div class="stat-value">{{ detectedTask || 'N/A' }}</div>
        <div class="stat-foot">Auto-detected</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Metrics tracked</div>
        <div class="stat-value">{{ selectedMetrics.length }}</div>
        <div class="stat-foot">{{ availableMetrics.length }} available</div>
      </div>
      <div class="stat-card highlight" *ngIf="getTopModel()">
        <div class="stat-label">Top candidate</div>
        <div class="stat-value">{{ getTopModel()?.modelName }}</div>
        <div class="stat-foot">Best composite score</div>
      </div>
    </div>

    <div class="progress-bar" *ngIf="isRunning">
      <div class="progress-fill" [style.width.%]="progress"></div>
    </div>
  </section>

  <section class="workspace-grid">
    <div class="stack">
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Model pool</h2>
            <p class="panel-subtitle">Select 2+ HTTP models with compatible inputs</p>
          </div>
          <span class="badge live">{{ selectedCount }} selected</span>
        </div>

        <div class="pool-alert" *ngIf="assetsError">
          <mat-icon>warning</mat-icon>
          {{ assetsError }}
        </div>

        <div class="search-bar">
          <mat-icon class="search-icon">search</mat-icon>
          <input 
            type="text" 
            placeholder="Search models by name, keywords, or task..." 
            [(ngModel)]="searchKeyword"
            (input)="filterModelPool()"
            class="search-input"
          />
          <button 
            *ngIf="searchKeyword" 
            (click)="clearSearch()" 
            class="clear-btn"
            mat-icon-button
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="model-filters">
          <button 
            class="pill" 
            [class.active]="activeFilter === 'all'"
            (click)="setFilter('all')"
          >
            All Tasks
          </button>
          <button 
            class="pill"
            [class.active]="activeFilter === 'classification'"
            (click)="setFilter('classification')"
          >
            Classification
          </button>
          <button 
            class="pill"
            [class.active]="activeFilter === 'regression'"
            (click)="setFilter('regression')"
          >
            Regression
          </button>
          <button 
            class="pill"
            [class.active]="activeFilter === 'nlp'"
            (click)="setFilter('nlp')"
          >
            NLP
          </button>
          <button 
            class="pill"
            [class.active]="activeFilter === 'vision'"
            (click)="setFilter('vision')"
          >
            Vision
          </button>
        </div>

        <div class="model-list">
          <div class="model-item loading" *ngIf="isLoadingAssets">
            <div class="model-select">
              <mat-spinner diameter="20"></mat-spinner>
            </div>
            <div>
              <div class="model-id">Loading HTTP models...</div>
              <div class="model-meta">Fetching catalog</div>
            </div>
            <div class="model-status neutral">Hold</div>
          </div>
          
          <div class="empty-state" *ngIf="!isLoadingAssets && filteredModelPoolAssets.length === 0">
            <mat-icon>inbox</mat-icon>
            <p>{{ searchKeyword || activeFilter !== 'all' ? 'No models match your search criteria' : 'No HTTP models available for benchmarking' }}</p>
          </div>

          <div
            class="model-item selectable"
            *ngFor="let asset of filteredModelPoolAssets"
            [class.selected]="isAssetSelected(asset)"
            (click)="toggleAssetSelection(asset)"
          >
            <div class="model-select">
              <input type="checkbox" [checked]="isAssetSelected(asset)" (click)="$event.stopPropagation()" />
            </div>
            <div class="model-content">
              <div class="model-id">
                {{ asset.name }}
                <span class="selected-badge" *ngIf="isAssetSelected(asset)">
                  <mat-icon>check_circle</mat-icon>
                  SELECTED
                </span>
              </div>
              <div class="model-meta">{{ getAssetMeta(asset) }}</div>
            </div>
            <div class="model-status" [class.success]="isAssetSelected(asset)" [class.ready]="!isAssetSelected(asset)">
              {{ isAssetSelected(asset) ? 'Selected' : 'Ready' }}
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Benchmark inputs</h2>
            <p class="panel-subtitle">Provide test data for model execution</p>
          </div>
          <div class="benchmark-actions">
            <div class="input-tabs">
              <button class="pill" [class.active]="inputMode === 'single'" (click)="setInputMode('single')">
                Single input
              </button>
              <button class="pill" [class.active]="inputMode === 'dataset'" (click)="setInputMode('dataset')">
                Dataset batch
              </button>
            </div>
            <button class="btn subtle" (click)="validateSchema()" [disabled]="isRunning || isObtainingOutputs">
              <mat-icon>fact_check</mat-icon>
              Validate Input
            </button>
            <button class="btn primary" (click)="obtainOutputs()" [disabled]="!canObtainOutputs">
              <mat-icon *ngIf="!isObtainingOutputs">bolt</mat-icon>
              <mat-icon *ngIf="isObtainingOutputs">
                <mat-spinner diameter="20"></mat-spinner>
              </mat-icon>
              {{ isObtainingOutputs ? 'Obtaining...' : 'Obtain Outputs' }}
            </button>
          </div>
        </div>

        <div class="status-banner" [class.success]="!isRunning && rankingRows.length > 0" [class.info]="isRunning">
          <mat-icon>{{ isRunning ? 'pending' : (rankingRows.length > 0 ? 'check_circle' : 'info') }}</mat-icon>
          <span>{{ statusMessage }}</span>
        </div>

        <div class="input-grid">
          <div class="input-card" [class.muted]="inputMode !== 'single'">
            <label class="field-label">Unified input schema</label>

            <div
              class="single-schema-form"
              *ngIf="standardizedInputFields.length > 0; else noUnifiedSchema"
            >
              <div class="single-schema-grid">
                <div class="schema-field-card" *ngFor="let field of standardizedInputFields">
                  <label class="schema-field-label">
                    {{ field.name }}
                    <span class="required-indicator" *ngIf="field.required">*</span>
                  </label>

                  <ng-container [ngSwitch]="field.type">
                    <select
                      *ngSwitchCase="'boolean'"
                      class="field-select"
                      [ngModel]="standardizedInputValues[field.name]"
                      (ngModelChange)="onSingleFieldValueChange(field, $event)"
                      [disabled]="inputMode !== 'single' || isRunning || isObtainingOutputs"
                    >
                      <option [ngValue]="true">true</option>
                      <option [ngValue]="false">false</option>
                    </select>

                    <input
                      *ngSwitchDefault
                      class="field-input"
                      [type]="getSingleFieldInputType(field)"
                      [min]="field.min"
                      [max]="field.max"
                      [step]="field.type === 'integer' ? 1 : 'any'"
                      [ngModel]="standardizedInputValues[field.name]"
                      (ngModelChange)="onSingleFieldValueChange(field, $event)"
                      [disabled]="inputMode !== 'single' || isRunning || isObtainingOutputs"
                    />
                  </ng-container>

                  <div class="schema-field-meta">
                    {{ getFieldConstraintsText(field) }}
                  </div>
                </div>
              </div>

              <div class="field-foot">
                <mat-icon>lightbulb</mat-icon>
                One standardized input is shared across all selected models (schema matched).
              </div>
            </div>

            <ng-template #noUnifiedSchema>
              <div class="empty-state-small compact">
                <mat-icon>rule</mat-icon>
                <p>Select compatible models to build a unified input form</p>
              </div>
            </ng-template>
          </div>

          <div class="input-card" [class.muted]="inputMode !== 'dataset'">
            <label class="field-label" for="benchmark-file">Dataset upload</label>
            <div class="upload-zone">
              <input
                id="benchmark-file"
                class="file-input"
                type="file"
                accept=".csv,.jsonl,.json"
                (change)="handleFileSelection($event)"
                [disabled]="inputMode !== 'dataset' || isRunning || isObtainingOutputs"
              />
              <label class="upload-label" for="benchmark-file">
                <mat-icon>cloud_upload</mat-icon>
                Drop CSV/JSONL or browse files
              </label>
              <div class="upload-meta">Max 500MB ‚Ä¢ Schema v2 ‚Ä¢ UTF-8</div>
              <div class="upload-meta success" *ngIf="selectedFileName">
                <mat-icon>check</mat-icon>
                Selected: {{ selectedFileName }}
              </div>
              <div class="upload-meta" *ngIf="datasetBatchInputs.length > 0">
                <mat-icon>list_alt</mat-icon>
                Rows detected: {{ datasetBatchInputs.length }}
              </div>
            </div>
            <div class="field-foot">
              <mat-icon>lightbulb</mat-icon>
              Upload data and run Obtain Outputs for each selected model
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="right-stack">
      <div class="panel recipe">
        <div class="panel-header">
          <div>
            <h2>Validation datasets</h2>
            <p class="panel-subtitle">Pre-loaded datasets for metric calculation</p>
          </div>
          <span class="badge solid">{{ detectedTask || 'Auto' }}</span>
        </div>

      <div class="dataset-section" *ngIf="availableDatasets.length > 0">
        <div class="dataset-grid">
          <div 
            class="dataset-card" 
            *ngFor="let dataset of availableDatasets"
            [class.selected]="selectedDatasetId === dataset.id"
            (click)="selectDataset(dataset.id)"
          >
            <div class="dataset-header">
              <mat-icon>dataset</mat-icon>
              <div class="dataset-name">{{ dataset.name }}</div>
            </div>
            <div class="dataset-info">
              <div class="dataset-samples">{{ dataset.samples }} samples</div>
              <div class="dataset-desc">{{ dataset.description }}</div>
            </div>
            <div class="dataset-status" *ngIf="selectedDatasetId === dataset.id">
              <mat-icon>check_circle</mat-icon>
              Selected
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state-small" *ngIf="availableDatasets.length === 0">
        <mat-icon>folder_open</mat-icon>
        <p>Select models to load validation datasets</p>
      </div>

      <div class="panel-header" style="margin-top: 2rem;">
        <div>
          <h2>Metrics configuration</h2>
          <p class="panel-subtitle">Select metrics for evaluation (task: {{ detectedTask || 'unknown' }})</p>
        </div>
        <span class="badge outline">{{ selectedMetrics.length }}/{{ availableMetrics.length }}</span>
      </div>

      <div class="metrics-section" *ngIf="availableMetrics.length > 0">
        <div class="metric-chips">
          <button 
            class="metric-chip" 
            *ngFor="let metric of availableMetrics"
            [class.active]="selectedMetrics.includes(metric)"
            (click)="toggleMetricSelection(metric)"
            [disabled]="isRunning"
          >
            <mat-icon *ngIf="selectedMetrics.includes(metric)">check_circle</mat-icon>
            <mat-icon *ngIf="!selectedMetrics.includes(metric)">radio_button_unchecked</mat-icon>
            {{ metric }}
          </button>
        </div>

        <div class="metric-info">
          <mat-icon>info</mat-icon>
          <span *ngIf="detectedTask === 'classification'">
            Classification metrics: AUC (Area Under Curve), GINI (2*AUC-1), Precision, Recall, F1 Score
          </span>
          <span *ngIf="detectedTask === 'regression'">
            Regression metrics: RMSE (Root Mean Squared Error), MAE (Mean Absolute Error), MSE, R¬≤ (Coefficient of Determination)
          </span>
          <span *ngIf="detectedTask === 'nlp'">
            NLP metrics: Accuracy, F1 Score, BLEU (translation quality), Perplexity (language model), ROUGE (summarization)
          </span>
          <span *ngIf="detectedTask === 'vision'">
            Vision metrics: Accuracy, Precision, Recall, mAP (mean Average Precision), IoU (Intersection over Union)
          </span>
        </div>
      </div>

      <div class="empty-state-small" *ngIf="availableMetrics.length === 0">
        <mat-icon>analytics</mat-icon>
        <p>Select models to configure metrics</p>
      </div>

        <div class="cost-config">
          <div class="config-item">
            <mat-icon>attach_money</mat-icon>
            <div>
              <div class="config-label">Cost per second</div>
              <div class="config-value">${{ costPerSecond }}</div>
            </div>
          </div>
          <div class="config-item">
            <mat-icon>speed</mat-icon>
            <div>
              <div class="config-label">Latency tracking</div>
              <div class="config-value">Enabled</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel outputs-panel">
        <div class="panel-header">
          <div>
            <h2>OutPuts</h2>
            <p class="panel-subtitle">Results generated from Obtain Outputs</p>
          </div>
          <span class="badge outline">{{ modelInputOutputs.length }} model(s)</span>
        </div>

        <div class="status-banner" [class.info]="isObtainingOutputs" [class.success]="!isObtainingOutputs && modelInputOutputs.length > 0">
          <mat-icon>{{ isObtainingOutputs ? 'pending' : (modelInputOutputs.length > 0 ? 'check_circle' : 'info') }}</mat-icon>
          <span>{{ outputStatusMessage }}</span>
        </div>

        <div class="outputs-actions" *ngIf="isDatasetOutputMode() && modelInputOutputs.length > 0">
          <label class="download-format-group">
            <span>Global format</span>
            <select
              class="download-format-select"
              [(ngModel)]="globalDatasetDownloadFormat"
            >
              <option value="json">JSON</option>
              <option value="csv">CSV</option>
            </select>
          </label>
          <button class="btn subtle" (click)="downloadAllDatasetOutputs()">
            <mat-icon>download</mat-icon>
            Download all dataset outputs
          </button>
        </div>

        <div *ngIf="modelInputOutputs.length > 0; else noOutputResults" class="outputs-table-container">
          <table class="outputs-table" *ngIf="isSingleOutputMode(); else datasetOutputsTable">
            <thead>
              <tr>
                <th>Model</th>
                <th>Status</th>
                <th>Primary result</th>
                <th>Confidence</th>
                <th>Latency</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let output of modelInputOutputs">
                <td>{{ output.modelName }}</td>
                <td>
                  <span class="output-state" [class.success]="output.status === 'success'" [class.partial]="output.status === 'partial'" [class.error]="output.status === 'error'">
                    {{ output.status }}
                  </span>
                </td>
                <td>{{ getPrimaryOutputValue(output) }}</td>
                <td>{{ getPrimaryOutputConfidence(output) }}</td>
                <td>{{ formatLatency(output.latencyMs) }}</td>
                <td>{{ output.errorMessage || '-' }}</td>
              </tr>
            </tbody>
          </table>

          <ng-template #datasetOutputsTable>
            <table class="outputs-table">
              <thead>
                <tr>
                  <th>Model</th>
                  <th>Status</th>
                  <th>Processed</th>
                  <th>OK</th>
                  <th>Fail</th>
                  <th>Latency</th>
                  <th>Summary</th>
                  <th>Download</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let output of modelInputOutputs">
                  <td>{{ output.modelName }}</td>
                  <td>
                    <span class="output-state" [class.success]="output.status === 'success'" [class.partial]="output.status === 'partial'" [class.error]="output.status === 'error'">
                      {{ output.status }}
                    </span>
                  </td>
                  <td>{{ output.processedInputs }}</td>
                  <td>{{ output.successfulOutputs }}</td>
                  <td>{{ output.failedOutputs }}</td>
                  <td>{{ formatLatency(output.latencyMs) }}</td>
                  <td>{{ getDatasetOutputSummary(output) }}</td>
                  <td>
                    <label class="download-format-group inline">
                      <span>Format</span>
                      <select
                        class="download-format-select"
                        [ngModel]="getDatasetDownloadFormat(output.modelId)"
                        (ngModelChange)="setDatasetDownloadFormat(output.modelId, $event)"
                      >
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                      </select>
                    </label>
                    <button class="table-download-btn" (click)="downloadDatasetModelOutput(output)">
                      <mat-icon>download</mat-icon>
                      Download
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </div>

        <ng-template #noOutputResults>
          <div class="empty-state-small">
            <mat-icon>preview</mat-icon>
            <p>Use Validate Input and Obtain Outputs to display results here</p>
          </div>
        </ng-template>
      </div>
    </div>
  </section>

  <section class="results-section" *ngIf="rankingRows.length > 0">
    <div class="panel results-panel">
      <div class="panel-header">
        <div>
          <h2>üèÜ Ranking Results</h2>
          <p class="panel-subtitle">Models ranked by composite score: 60% {{ recommendationMetric }}, 25% latency, 15% cost</p>
        </div>
        <div class="header-actions">
          <span class="badge outline">{{ rankingRows.length }} models evaluated</span>
          <button class="btn subtle" (click)="rankingRows = []">
            <mat-icon>close</mat-icon>
            Clear Results
          </button>
        </div>
      </div>

      <div class="ranking-table-container">
        <table class="ranking-table">
          <thead>
            <tr class="table-header">
              <th class="col-rank">Rank</th>
              <th class="col-model">Model Name</th>
              <th class="col-metric" *ngFor="let metric of selectedMetrics">{{ metric }}</th>
              <th class="col-latency">Latency</th>
              <th class="col-cost">Cost</th>
              <th class="col-score">Score</th>
            </tr>
          </thead>
          <tbody>
            <tr 
              class="table-row" 
              *ngFor="let row of rankingRows"
              [class.row-winner]="row.top"
              [class.row-top3]="row.rank <= 3 && !row.top"
            >
              <td class="col-rank">
                <div class="rank-badge" [class.badge-winner]="row.top" [class.badge-top3]="row.rank <= 3 && !row.top">
                  <mat-icon *ngIf="row.top" class="trophy-icon">emoji_events</mat-icon>
                  <span *ngIf="!row.top" class="rank-number">{{ row.rank }}</span>
                </div>
              </td>
              <td class="col-model">
                <div class="model-cell">
                  <span class="model-name-text">{{ row.modelName }}</span>
                  <span class="model-badge-top" *ngIf="row.top">TOP PERFORMER</span>
                </div>
              </td>
              <td class="col-metric" *ngFor="let metric of selectedMetrics">
                <span class="metric-value">{{ formatMetricValue(row.metrics[metric] || 0, metric) }}</span>
              </td>
              <td class="col-latency">
                <div class="latency-cell">
                  <mat-icon class="cell-icon">schedule</mat-icon>
                  <span>{{ formatLatency(row.latency) }}</span>
                </div>
              </td>
              <td class="col-cost">
                <div class="cost-cell">
                  <mat-icon class="cell-icon">attach_money</mat-icon>
                  <span>{{ formatCost(row.cost) }}</span>
                </div>
              </td>
              <td class="col-score">
                <div class="score-cell">
                  <span class="score-value">{{ row.compositeScore?.toFixed(3) || 'N/A' }}</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="table-actions">
        <button class="btn ghost" (click)="exportResults()">
          <mat-icon>download</mat-icon>
          Export CSV
        </button>
        <button class="btn ghost" (click)="runRanking()" [disabled]="isRunning">
          <mat-icon>refresh</mat-icon>
          Re-run Benchmark
        </button>
      </div>
    </div>

    <!-- Recommendation Section -->
    <div class="panel recommendation-panel" *ngIf="getBestModelByMetric() as bestModel">
      <div class="recommendation-header">
        <div class="header-left">
          <div class="trophy-icon-large">üèÜ</div>
          <div>
            <h2>Best Model by {{ recommendationMetric }}</h2>
            <p class="panel-subtitle">Top performer based on selected metric</p>
          </div>
        </div>
      </div>

      <div class="recommendation-body">
        <div class="best-model-card">
          <div class="model-info-section">
            <div class="model-icon">ü§ñ</div>
            <div class="model-details">
              <h3 class="model-name-large">{{ bestModel.modelName }}</h3>
              <p class="model-id-text">{{ bestModel.modelId }}</p>
              <div class="model-rank-badge">
                <mat-icon>emoji_events</mat-icon>
                <span>Rank #{{ bestModel.rank }} Overall</span>
              </div>
            </div>
          </div>

          <div class="metrics-showcase">
            <div class="showcase-title">Performance Metrics</div>
            <div class="metrics-grid">
              <div class="metric-card primary-metric">
                <mat-icon class="metric-icon">star</mat-icon>
                <div class="metric-info">
                  <div class="metric-label">{{ recommendationMetric }}</div>
                  <div class="metric-value-large">
                    {{ formatMetricValue(bestModel.metrics[recommendationMetric] || 0, recommendationMetric) }}
                  </div>
                </div>
              </div>

              <div class="metric-card" *ngFor="let metric of selectedMetrics.slice(0, 4)">
                <div class="metric-info">
                  <div class="metric-label-small">{{ metric }}</div>
                  <div class="metric-value-medium">
                    {{ formatMetricValue(bestModel.metrics[metric] || 0, metric) }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="performance-indicators">
            <div class="indicator-item">
              <mat-icon class="indicator-icon latency">schedule</mat-icon>
              <div class="indicator-content">
                <div class="indicator-label">Latency</div>
                <div class="indicator-value">{{ formatLatency(bestModel.latency) }}</div>
              </div>
            </div>

            <div class="indicator-item">
              <mat-icon class="indicator-icon cost">attach_money</mat-icon>
              <div class="indicator-content">
                <div class="indicator-label">Cost</div>
                <div class="indicator-value">{{ formatCost(bestModel.cost) }}</div>
              </div>
            </div>

            <div class="indicator-item">
              <mat-icon class="indicator-icon score">workspace_premium</mat-icon>
              <div class="indicator-content">
                <div class="indicator-label">Composite Score</div>
                <div class="indicator-value">{{ bestModel.compositeScore?.toFixed(3) || 'N/A' }}</div>
              </div>
            </div>
          </div>

          <div class="recommendation-notes">
            <div class="note-item">
              <mat-icon>check_circle</mat-icon>
              <span>Best {{ recommendationMetric }} performance in benchmark</span>
            </div>
            <div class="note-item">
              <mat-icon>trending_up</mat-icon>
              <span>Validated against {{ getSelectedDatasetName() }}</span>
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn primary">
              <mat-icon>rocket_launch</mat-icon>
              Deploy Model
            </button>
            <button class="btn outline">
              <mat-icon>info</mat-icon>
              View Details
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="empty-results" *ngIf="rankingRows.length === 0 && !isRunning">
    <mat-icon>assessment</mat-icon>
    <h3>No benchmark results yet</h3>
    <p>Select models, configure metrics, and run the benchmark to see results here</p>
  </section>
</div>
