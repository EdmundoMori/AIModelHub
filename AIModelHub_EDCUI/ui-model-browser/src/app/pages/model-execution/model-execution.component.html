<div class="model-execution-container">
  <!-- Header -->
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">
      ‚Üê Back to Assets
    </button>
    <h1>üöÄ IA Execution</h1>
    <p class="subtitle">Execute AI models through REST API endpoints</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading asset information...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="execution-content">
    
    <!-- Model Selection (if no asset preselected) -->
    <div *ngIf="!selectedAsset && executableAssets.length > 0" class="model-selector">
      <label for="assetSelect">Select a model to execute:</label>
      <select 
        id="assetSelect" 
        (change)="onAssetSelect($event)"
        class="asset-select">
        <option value="">-- Choose an executable model --</option>
        <option 
          *ngFor="let asset of executableAssets" 
          [value]="asset.id">
          {{ asset.name }} ({{ asset.algorithm || 'ML Model' }})
        </option>
      </select>
    </div>

    <!-- No Executable Assets -->
    <div *ngIf="!selectedAsset && executableAssets.length === 0 && !loadingAssets" class="empty-state">
      <div class="empty-icon">üì¶</div>
      <h2>No Executable Models Available</h2>
      <p>There are no executable models registered in the catalog.</p>
      <p>Executable models must have an HTTP endpoint configured.</p>
    </div>

    <!-- Selected Model Info -->
    <div *ngIf="selectedAsset" class="model-info-card">
      <div class="model-header">
        <h2>{{ selectedAsset.name }}</h2>
        <span class="badge badge-primary">{{ selectedAsset.asset_type }}</span>
      </div>
      
      <div class="model-details">
        <div class="detail-row">
          <span class="label">Endpoint:</span>
          <span class="value">{{ selectedAsset.execution_endpoint }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Method:</span>
          <span class="value">{{ selectedAsset.execution_method }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Timeout:</span>
          <span class="value">{{ selectedAsset.execution_timeout }}ms</span>
        </div>
        <div class="detail-row" *ngIf="selectedAsset.algorithm">
          <span class="label">Algorithm:</span>
          <span class="value">{{ selectedAsset.algorithm }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedAsset.framework">
          <span class="label">Framework:</span>
          <span class="value">{{ selectedAsset.framework }}</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div *ngIf="selectedAsset" class="tabs">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'input'"
        (click)="activeTab = 'input'">
        Input
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'output'"
        (click)="activeTab = 'output'">
        Output
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'history'"
        (click)="viewHistory()">
        History ({{ executionHistory.length }})
      </button>
    </div>

    <!-- Tab Content -->
    <div *ngIf="selectedAsset" class="tab-content">
      
      <!-- Input Tab -->
      <div *ngIf="activeTab === 'input'" class="input-panel">
        <div class="panel-header">
          <h3>Model Input</h3>
          <div class="header-actions">
            <button 
              *ngIf="inputFields.length > 0"
              class="btn-secondary btn-sm"
              (click)="toggleInputMode()"
              title="Toggle between form and JSON input">
              {{ inputMode === 'form' ? 'üìù JSON Mode' : 'üìã Form Mode' }}
            </button>
            <button 
              class="btn-primary" 
              (click)="executeModel()"
              [disabled]="executing">
              <span *ngIf="!executing">‚ñ∂ Execute Model</span>
              <span *ngIf="executing">‚è≥ Executing...</span>
            </button>
          </div>
        </div>
        
        <!-- Dynamic Form Mode -->
        <div *ngIf="inputMode === 'form' && inputFields.length > 0" class="form-section">
          <div class="form-group" *ngFor="let field of inputFields">
            <label [for]="field.name" class="form-label">
              {{ field.name }}
              <span *ngIf="field.required" class="required">*</span>
              <span *ngIf="field.description" class="field-hint">
                üí° {{ field.description }}
              </span>
            </label>
            
            <!-- Text Input -->
            <input 
              *ngIf="field.type === 'string'"
              [id]="field.name"
              [(ngModel)]="field.value"
              type="text"
              class="form-input"
              [required]="field.required"
              [placeholder]="field.description || 'Enter ' + field.name" />
            
            <!-- Number Input (Float) -->
            <input 
              *ngIf="field.type === 'float' || field.type === 'number'"
              [id]="field.name"
              [(ngModel)]="field.value"
              type="number"
              step="0.1"
              class="form-input"
              [required]="field.required"
              [attr.min]="field.min"
              [attr.max]="field.max"
              [placeholder]="field.description || 'Enter ' + field.name" />
            
            <!-- Integer Input -->
            <input 
              *ngIf="field.type === 'int'"
              [id]="field.name"
              [(ngModel)]="field.value"
              type="number"
              step="1"
              class="form-input"
              [required]="field.required"
              [attr.min]="field.min"
              [attr.max]="field.max"
              [placeholder]="field.description || 'Enter ' + field.name" />
            
            <!-- Boolean Input -->
            <label *ngIf="field.type === 'boolean'" class="checkbox-label">
              <input 
                [id]="field.name"
                [(ngModel)]="field.value"
                type="checkbox"
                class="form-checkbox" />
              <span>Enable {{ field.name }}</span>
            </label>
            
            <!-- Range hint for numeric fields -->
            <div *ngIf="(field.type === 'float' || field.type === 'number' || field.type === 'int') && (field.min !== undefined || field.max !== undefined)" class="range-hint">
              <span *ngIf="field.min !== undefined">Min: {{ field.min }}</span>
              <span *ngIf="field.max !== undefined">Max: {{ field.max }}</span>
            </div>
          </div>
          
          <div *ngIf="inputError" class="error-message">
            ‚ö†Ô∏è {{ inputError }}
          </div>
        </div>
        
        <!-- JSON Mode -->
        <div *ngIf="inputMode === 'json'" class="input-section">
          <label for="inputJson">Input JSON Payload:</label>
          <textarea 
            id="inputJson"
            [(ngModel)]="inputJson"
            class="json-input"
            rows="12"
            placeholder='{ "feature1": 0.5, "feature2": 1.2 }'
            [class.error]="inputError">
          </textarea>
          <div *ngIf="inputError" class="error-message">
            ‚ö†Ô∏è {{ inputError }}
          </div>
          <div class="input-hint">
            üí° Tip: Modify the JSON above to match your model's expected input format
          </div>
        </div>
      </div>

      <!-- Output Tab -->
      <div *ngIf="activeTab === 'output'" class="output-panel">
        
        <!-- Executing State -->
        <div *ngIf="executing" class="executing-state">
          <div class="spinner"></div>
          <h3>Executing Model...</h3>
          <p>Waiting for response from {{ selectedAsset.execution_endpoint }}</p>
        </div>

        <!-- No Result Yet -->
        <div *ngIf="!executing && !executionResult" class="empty-output">
          <div class="empty-icon">üìä</div>
          <p>No execution result yet. Execute the model to see output.</p>
        </div>

        <!-- Execution Result -->
        <div *ngIf="!executing && executionResult" class="result-container">
          
          <!-- Status Header -->
          <div class="result-header">
            <h3>Execution Result</h3>
            <span [class]="'badge ' + getStatusClass(executionResult.status)">
              {{ executionResult.status.toUpperCase() }}
            </span>
          </div>

          <!-- Metadata -->
          <div class="result-metadata">
            <div class="metadata-item">
              <span class="label">Execution ID:</span>
              <span class="value">{{ executionResult.executionId }}</span>
            </div>
            <div class="metadata-item" *ngIf="executionResult.executionTimeMs">
              <span class="label">Execution Time:</span>
              <span class="value">{{ formatExecutionTime(executionResult.executionTimeMs) }}</span>
            </div>
            <div class="metadata-item">
              <span class="label">Timestamp:</span>
              <span class="value">{{ executionResult.timestamp | date:'medium' }}</span>
            </div>
          </div>

          <!-- Success Output -->
          <div *ngIf="executionResult.status === 'success'" class="output-success">
            <h4>‚úÖ Output Data:</h4>
            <pre class="json-output">{{ executionResult.output | json }}</pre>
          </div>

          <!-- Error Output -->
          <div *ngIf="executionResult.status === 'error' || executionResult.status === 'timeout'" class="output-error">
            <h4>‚ùå Error Details:</h4>
            <div class="error-details">
              <p><strong>Message:</strong> {{ executionResult.error?.message }}</p>
              <p><strong>Code:</strong> {{ executionResult.error?.code }}</p>
              <p *ngIf="executionResult.error?.httpStatus">
                <strong>HTTP Status:</strong> {{ executionResult.error?.httpStatus }}
              </p>
            </div>
            <details *ngIf="executionResult.error?.details">
              <summary>Show detailed error</summary>
              <pre class="json-output">{{ executionResult.error?.details | json }}</pre>
            </details>
          </div>
        </div>
      </div>

      <!-- History Tab -->
      <div *ngIf="activeTab === 'history'" class="history-panel">
        <h3>Execution History</h3>
        
        <div *ngIf="executionHistory.length === 0" class="empty-history">
          <p>No execution history available for this model.</p>
        </div>

        <div *ngIf="executionHistory.length > 0" class="history-list">
          <div *ngFor="let execution of executionHistory" class="history-item">
            <div class="history-header">
              <span [class]="'badge ' + getStatusClass(execution.status)">
                {{ execution.status }}
              </span>
              <span class="history-time">
                {{ execution.created_at | date:'short' }}
              </span>
              <span class="history-duration" *ngIf="execution.execution_time_ms">
                {{ formatExecutionTime(execution.execution_time_ms) }}
              </span>
            </div>
            <div class="history-details">
              <details>
                <summary>View details</summary>
                <div class="history-content">
                  <div class="history-section">
                    <strong>Input:</strong>
                    <pre class="json-small">{{ execution.input_payload | json }}</pre>
                  </div>
                  <div class="history-section" *ngIf="execution.output_payload">
                    <strong>Output:</strong>
                    <pre class="json-small">{{ execution.output_payload | json }}</pre>
                  </div>
                  <div class="history-section" *ngIf="execution.error_message">
                    <strong>Error:</strong>
                    <p class="error-text">{{ execution.error_message }}</p>
                  </div>
                </div>
              </details>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
