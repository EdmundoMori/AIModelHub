<div class="negotiation-container">
  <!-- Header -->
  <div class="header">
    <h1>ü§ù EDC Contract Negotiation Simulator</h1>
    <p class="subtitle">Test contract negotiation flows between simulated EDC connectors</p>
    
    <div class="header-actions">
      <button 
        class="btn btn-refresh" 
        (click)="refreshData()" 
        [disabled]="loading">
        üîÑ Refresh
      </button>
      
      <button 
        class="btn"
        [class.btn-success]="autoRefresh"
        [class.btn-secondary]="!autoRefresh"
        (click)="toggleAutoRefresh()">
        {{ autoRefresh ? '‚è∏Ô∏è Stop Auto-Refresh' : '‚ñ∂Ô∏è Start Auto-Refresh' }}
      </button>
    </div>
  </div>

  <!-- Message Alert -->
  <div 
    *ngIf="message" 
    class="alert"
    [class.alert-success]="messageType === 'success'"
    [class.alert-error]="messageType === 'error'"
    [class.alert-info]="messageType === 'info'">
    {{ message }}
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab"
      [class.active]="activeTab === 'demo'"
      (click)="setActiveTab('demo')">
      üéÆ Demo Negotiation
    </button>
    <button 
      class="tab"
      [class.active]="activeTab === 'negotiations'"
      (click)="setActiveTab('negotiations')">
      üìã Negotiations ({{ negotiations.length }})
    </button>
    <button 
      class="tab"
      [class.active]="activeTab === 'connectors'"
      (click)="setActiveTab('connectors')">
      üîå Simulated Connectors ({{ connectors.length }})
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- DEMO TAB -->
    <div *ngIf="activeTab === 'demo'" class="demo-section">
      <div class="info-box">
        <h3>üéØ How It Works</h3>
        <p>This simulator allows you to test EDC contract negotiation between two connectors:</p>
        <ol>
          <li><strong>Consumer</strong> (you) initiates a negotiation for an asset</li>
          <li><strong>Provider</strong> (simulated) responds based on configured behavior</li>
          <li>Watch the negotiation progress through different states</li>
          <li>View the final agreement once negotiation completes</li>
        </ol>
        <p class="note">üí° Simulated connectors respond automatically based on their behavior settings</p>
      </div>

      <div class="demo-form">
        <h3>Start New Negotiation</h3>
        
        <div class="form-group">
          <label>Select Asset to Negotiate:</label>
          <select [ngModel]="selectedAssetId" (ngModelChange)="updateSelectedAssetId($event)" class="form-control">
            <option value="">-- Select an asset --</option>
            <option *ngFor="let asset of assets" [value]="asset.id">
              {{ asset.name }} ({{ asset.id }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Select Provider Connector:</label>
          <select [ngModel]="selectedProviderId" (ngModelChange)="updateSelectedProviderId($event)" class="form-control">
            <option value="">-- Select a provider --</option>
            <option *ngFor="let conn of availableProviders" [value]="conn.id">
              {{ conn.name }} - {{ conn.behavior }}
              {{ conn.isActive ? '‚úÖ' : '‚ùå' }}
            </option>
          </select>
        </div>
          <div *ngIf="selectedProviderId" class="provider-info">
            <p><strong>Behavior:</strong> 
              <span [class]="'badge badge-' + getBehaviorColor(getSelectedConnector()?.behavior || '')">
                {{ getSelectedConnector()?.behavior }}
              </span>
            </p>
            <p class="description">
              {{ getBehaviorDescription(getSelectedConnector()?.behavior || '') }}
            </p>
          </div>
        </div>

        <button 
          class="btn btn-primary btn-large"
          (click)="startDemoNegotiation()"
          [disabled]="loading || !selectedAssetId || !selectedProviderId">
          {{ loading ? '‚è≥ Starting...' : 'üöÄ Start Negotiation' }}
        </button>
      </div>

      <!-- Recent Negotiations Preview -->
      <div *ngIf="negotiations.length > 0" class="recent-negotiations">
        <h3>Recent Negotiations</h3>
        <div class="negotiation-list">
          <div 
            *ngFor="let neg of negotiations.slice(0, 5)" 
            class="negotiation-card mini">
            <div class="negotiation-header">
              <span [class]="'badge badge-' + getStateColor(neg.state)">
                {{ neg.state }}
              </span>
              <span class="time">{{ getTimeSince(neg.created_at) }}</span>
            </div>
            <div class="negotiation-body">
              <p><strong>Asset:</strong> {{ getAssetName(neg.asset_id) }}</p>
              <p><strong>Provider:</strong> {{ getConnectorName(neg.provider_id) }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- NEGOTIATIONS TAB -->
    <div *ngIf="activeTab === 'negotiations'" class="negotiations-section">
      <div class="section-header">
        <h2>All Negotiations</h2>
        <p>View all contract negotiations and their current states</p>
      </div>

      <div *ngIf="negotiations.length === 0" class="empty-state">
        <p>üì≠ No negotiations yet</p>
        <p>Start a demo negotiation to see it here</p>
      </div>

      <div class="negotiation-list">
        <div *ngFor="let neg of negotiations" class="negotiation-card">
          <div class="negotiation-header">
            <div>
              <h4>{{ neg.id }}</h4>
              <span class="time">Created {{ formatDate(neg.created_at) }}</span>
            </div>
            <span [class]="'badge badge-' + getStateColor(neg.state)">
              {{ neg.state }}
            </span>
          </div>

          <div class="negotiation-body">
            <div class="info-grid">
              <div class="info-item">
                <label>Asset:</label>
                <span>{{ getAssetName(neg.asset_id) }}</span>
              </div>
              <div class="info-item">
                <label>Provider:</label>
                <span>{{ getConnectorName(neg.provider_id) }}</span>
              </div>
              <div class="info-item">
                <label>Consumer:</label>
                <span>{{ neg.counterparty_id }}</span>
              </div>
              <div class="info-item" *ngIf="neg.agreement_id">
                <label>Agreement:</label>
                <span>{{ neg.agreement_id }}</span>
              </div>
            </div>

            <div *ngIf="neg.error_detail" class="error-detail">
              ‚ö†Ô∏è {{ neg.error_detail }}
            </div>

            <div class="timeline">
              <div class="timeline-item" [class.active]="neg.state === 'REQUESTED'">
                <div class="timeline-marker"></div>
                <div class="timeline-content">REQUESTED</div>
              </div>
              <div class="timeline-item" [class.active]="['OFFERED','ACCEPTED','AGREED','VERIFIED','FINALIZED'].includes(neg.state)">
                <div class="timeline-marker"></div>
                <div class="timeline-content">OFFERED</div>
              </div>
              <div class="timeline-item" [class.active]="['ACCEPTED','AGREED','VERIFIED','FINALIZED'].includes(neg.state)">
                <div class="timeline-marker"></div>
                <div class="timeline-content">ACCEPTED</div>
              </div>
              <div class="timeline-item" [class.active]="['AGREED','VERIFIED','FINALIZED'].includes(neg.state)">
                <div class="timeline-marker"></div>
                <div class="timeline-content">AGREED</div>
              </div>
              <div class="timeline-item" [class.active]="neg.state === 'FINALIZED'">
                <div class="timeline-marker"></div>
                <div class="timeline-content">FINALIZED</div>
              </div>
            </div>

            <div *ngIf="neg.finalized_at" class="finalized-info">
              ‚úÖ Finalized {{ formatDate(neg.finalized_at) }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONNECTORS TAB -->
    <div *ngIf="activeTab === 'connectors'" class="connectors-section">
      <div class="section-header">
        <h2>Simulated EDC Connectors</h2>
        <p>Manage simulated provider connectors for testing negotiations</p>
        <button class="btn btn-primary" (click)="toggleNewConnectorForm()">
          {{ showNewConnectorForm ? '‚ùå Cancel' : '‚ûï Add Connector' }}
        </button>
      </div>

      <!-- New Connector Form -->
      <div *ngIf="showNewConnectorForm" class="connector-form">
        <h3>Create New Connector</h3>
        
        <div class="form-group">
          <label>Connector Name:</label>
          <input 
            type="text" 
            [ngModel]="newConnector.name" 
            (ngModelChange)="updateNewConnectorName($event)"
            class="form-control"
            placeholder="e.g., My Provider Connector">
        </div>

        <div class="form-group">
          <label>Behavior:</label>
          <select [ngModel]="newConnector.behavior" (ngModelChange)="updateNewConnectorBehavior($event)" class="form-control">
            <option value="auto-accept">Auto-Accept (approves immediately)</option>
            <option value="auto-reject">Auto-Reject (declines immediately)</option>
            <option value="auto-offer">Auto-Offer (makes offer, waits)</option>
            <option value="slow-accept">Slow Accept (5s delay)</option>
            <option value="manual">Manual (requires manual action)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Response Time (ms):</label>
          <input 
            type="number" 
            [ngModel]="newConnector.responseTime" 
            (ngModelChange)="updateNewConnectorResponseTime($event)"
            class="form-control"
            min="100"
            max="10000">
        </div>

        <button 
          class="btn btn-primary"
          (click)="createConnector()"
          [disabled]="loading">
          Create Connector
        </button>
      </div>

      <!-- Connectors List -->
      <div class="connector-list">
        <div *ngFor="let conn of connectors" class="connector-card">
          <div class="connector-header">
            <div>
              <h4>
                {{ conn.name }}
                <span *ngIf="conn.isActive" class="status-badge active">‚úÖ Active</span>
                <span *ngIf="!conn.isActive" class="status-badge inactive">‚ùå Inactive</span>
              </h4>
              <p class="connector-id">{{ conn.id }}</p>
            </div>
            <button 
              class="btn btn-sm"
              [class.btn-danger]="conn.isActive"
              [class.btn-success]="!conn.isActive"
              (click)="toggleConnector(conn.id)">
              {{ conn.isActive ? 'Deactivate' : 'Activate' }}
            </button>
          </div>

          <div class="connector-body">
            <div class="info-grid">
              <div class="info-item">
                <label>Behavior:</label>
                <span [class]="'badge badge-' + getBehaviorColor(conn.behavior)">
                  {{ conn.behavior }}
                </span>
              </div>
              <div class="info-item">
                <label>Response Time:</label>
                <span>{{ conn.responseTime }}ms</span>
              </div>
              <div class="info-item">
                <label>Endpoint:</label>
                <span class="endpoint">{{ conn.endpoint }}</span>
              </div>
            </div>

            <p class="description">{{ getBehaviorDescription(conn.behavior) }}</p>

            <div *ngIf="conn.stats && getObjectKeys(conn.stats).length > 0" class="stats">
              <h5>Statistics:</h5>
              <div class="stats-grid">
                <div *ngFor="let key of getObjectKeys(conn.stats)" class="stat-item">
                  <span class="stat-label">{{ key }}:</span>
                  <span class="stat-value">{{ conn.stats[key] }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="connectors.length === 0" class="empty-state">
        <p>üîå No connectors configured</p>
        <p>Click "Add Connector" to create a simulated provider</p>
      </div>
    </div>

  </div>

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Processing...</p>
  </div>

